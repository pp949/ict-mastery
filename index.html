<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSE ICT Mastery | Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .stat-card { background: white; border-radius: 1.5rem; padding: 1.25rem; border: 1px solid #f1f5f9; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); }
        .loading-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-[#f8fafc]">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInAnonymously 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, getDocs, addDoc, serverTimestamp, onSnapshot, query, where, orderBy, limit
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Bridge for React
        window.FirebaseBridge = {
            init: () => {
                try {
                    const config = JSON.parse(__firebase_config);
                    const app = initializeApp(config);
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    const provider = new GoogleAuthProvider();
                    
                    return {
                        auth, db, provider,
                        lib: { onAuthStateChanged, collection, getDocs, addDoc, serverTimestamp, onSnapshot, query, where, orderBy, limit, signInWithPopup, signInAnonymously, signOut }
                    };
                } catch (e) {
                    console.error("Firebase Bridge Error:", e);
                    return null;
                }
            }
        };
        window.dispatchEvent(new Event('firebase-bridge-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const Icon = ({ name, className }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name, className]);
            return <i data-lucide={name} className={className}></i>;
        };

        function App() {
            const [sdk, setSdk] = useState(null);
            const [user, setUser] = useState(null);
            const [view, setView] = useState('lobby'); 
            const [allQuestions, setAllQuestions] = useState([]);
            const [attempts, setAttempts] = useState([]);
            const [currentQuiz, setCurrentQuiz] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [feedback, setFeedback] = useState(null);
            const [sessionScore, setSessionScore] = useState(0);
            const [loading, setLoading] = useState(true);
            const [appId] = useState(typeof __app_id !== 'undefined' ? __app_id : 'default-app-id');
            const [error, setError] = useState(null);

            // 1. Initialize SDK with retry logic
            useEffect(() => {
                const setup = () => {
                    if (window.FirebaseBridge) {
                        const instance = window.FirebaseBridge.init();
                        if (instance) {
                            setSdk(instance);
                            instance.lib.onAuthStateChanged(instance.auth, (u) => {
                                if (!u) {
                                    // Auto-login anonymously if no user is found to prevent hang
                                    instance.lib.signInAnonymously(instance.auth).catch(e => setError("Auth failed"));
                                }
                                setUser(u);
                                setLoading(false);
                            });
                        } else {
                            setError("Configuration missing");
                        }
                    }
                };

                if (window.FirebaseBridge) setup();
                else window.addEventListener('firebase-bridge-ready', setup);
                
                const timer = setTimeout(() => {
                    if (loading) setError("Connection timeout. Please refresh.");
                }, 8000);

                return () => {
                    window.removeEventListener('firebase-bridge-ready', setup);
                    clearTimeout(timer);
                };
            }, []);

            // 2. Data Subscriptions
            useEffect(() => {
                if (!user || !sdk) return;
                const { db, lib } = sdk;

                const qRef = lib.collection(db, 'artifacts', appId, 'public', 'data', 'questions');
                const unsubQuestions = lib.onSnapshot(qRef, 
                    (snap) => setAllQuestions(snap.docs.map(d => ({ id: d.id, ...d.data() }))),
                    (err) => console.warn("Questions listener:", err)
                );

                const aRef = lib.collection(db, 'artifacts', appId, 'users', user.uid, 'attempts');
                const unsubAttempts = lib.onSnapshot(aRef, 
                    (snap) => setAttempts(snap.docs.map(d => d.data())),
                    (err) => console.warn("Attempts listener:", err)
                );

                return () => { unsubQuestions(); unsubAttempts(); };
            }, [user, sdk, appId]);

            const stats = useMemo(() => {
                if (attempts.length === 0) return { accuracy: 0, activeDays: 0, bestTags: [] };
                const correctCount = attempts.filter(a => a.isCorrect).length;
                const accuracy = Math.round((correctCount / attempts.length) * 100);
                const activeDays = new Set(attempts.map(a => {
                    const d = a.timestamp?.toDate ? a.timestamp.toDate() : new Date();
                    return d.toDateString();
                })).size;
                
                const tagMap = {};
                attempts.forEach(a => {
                    const t = a.topic || "General";
                    tagMap[t] = (tagMap[t] || 0) + (a.isCorrect ? 1 : -0.5);
                });
                const bestTags = Object.entries(tagMap).sort((a,b) => b[1] - a[1]).slice(0, 2).map(x => x[0]);

                return { accuracy, activeDays, bestTags };
            }, [attempts]);

            const startQuiz = () => {
                if (allQuestions.length === 0) return alert("Waiting for questions from teacher...");
                const selected = _.sampleSize(allQuestions, 5);
                setCurrentQuiz(selected);
                setCurrentIndex(0);
                setSessionScore(0);
                setView('quiz');
            };

            const handleAnswer = async (idx) => {
                if (feedback || !sdk || !user) return;
                const q = currentQuiz[currentIndex];
                const isCorrect = idx === q.correct_answer;
                if (isCorrect) setSessionScore(s => s + 1);
                setFeedback(isCorrect ? 'correct' : 'wrong');

                const { db, lib } = sdk;
                const record = {
                    uid: user.uid,
                    displayName: user.displayName || "Anonymous Student",
                    topic: (Array.isArray(q.topic_tags) ? q.topic_tags[0] : q.topic) || "General",
                    questionId: q.id,
                    isCorrect,
                    timestamp: lib.serverTimestamp()
                };

                try {
                    await lib.addDoc(lib.collection(db, 'artifacts', appId, 'users', user.uid, 'attempts'), record);
                    await lib.addDoc(lib.collection(db, 'artifacts', appId, 'public', 'data', 'activity_feed'), record);
                } catch (e) { console.error("Save error:", e); }

                setTimeout(() => {
                    if (currentIndex + 1 < currentQuiz.length) {
                        setCurrentIndex(i => i + 1);
                        setFeedback(null);
                    } else {
                        setView('results');
                        setFeedback(null);
                    }
                }, 1000);
            };

            if (error) return (
                <div className="h-screen flex flex-col items-center justify-center bg-white p-6 text-center">
                    <Icon name="alert-circle" className="w-12 h-12 text-red-500 mb-4" />
                    <h2 className="text-xl font-bold text-slate-800">Connection Error</h2>
                    <p className="text-slate-500 text-sm mt-2 mb-6">{error}</p>
                    <button onClick={() => window.location.reload()} className="bg-slate-900 text-white px-8 py-3 rounded-xl font-bold">Try Again</button>
                </div>
            );

            if (loading) return (
                <div className="h-screen flex flex-col items-center justify-center bg-slate-50">
                    <div className="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center mb-4 loading-pulse shadow-lg shadow-blue-200">
                        <Icon name="cpu" className="w-6 h-6 text-white" />
                    </div>
                    <p className="text-[10px] font-black uppercase text-slate-400 tracking-[0.2em]">Synchronizing Portal</p>
                </div>
            );

            return (
                <div className="min-h-screen pb-12">
                    <header className="bg-white/80 backdrop-blur-md border-b sticky top-0 z-50 px-6 py-4 flex justify-between items-center">
                        <div className="flex items-center gap-2 font-black italic text-slate-900 tracking-tighter">
                            <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white">
                                <Icon name="zap" className="w-5 h-5" />
                            </div>
                            DSE ICT
                        </div>
                        <div className="flex items-center gap-3">
                            {user?.isAnonymous === false && (
                                <button onClick={() => sdk.lib.signOut(sdk.auth)} className="text-[10px] font-bold text-slate-400 hover:text-red-500 transition-colors">EXIT</button>
                            )}
                            <div className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center border text-slate-400">
                                <Icon name="user" className="w-4 h-4" />
                            </div>
                        </div>
                    </header>

                    <main className="max-w-xl mx-auto p-4 pt-8">
                        {view === 'lobby' && (
                            <div className="space-y-6 fade-in">
                                <div>
                                    <h2 className="text-2xl font-black text-slate-800 tracking-tight">Hi, {user?.displayName || "Student"}</h2>
                                    <p className="text-xs font-bold text-slate-400 uppercase tracking-wide mt-1">Ready for your daily practice?</p>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div className="stat-card">
                                        <p className="text-[9px] font-black text-slate-400 uppercase mb-1">Accuracy</p>
                                        <div className="text-3xl font-black text-blue-600">{stats.accuracy}%</div>
                                    </div>
                                    <div className="stat-card">
                                        <p className="text-[9px] font-black text-slate-400 uppercase mb-1">Active Days</p>
                                        <div className="text-3xl font-black text-slate-800">{stats.activeDays}</div>
                                    </div>
                                </div>

                                <div className="stat-card bg-slate-900 text-white border-none relative overflow-hidden">
                                    <div className="relative z-10">
                                        <p className="text-[9px] font-black text-blue-400 uppercase mb-3">Topic Performance</p>
                                        <div className="flex flex-wrap gap-2">
                                            {stats.bestTags.length > 0 ? stats.bestTags.map(t => (
                                                <span key={t} className="px-3 py-1 bg-white/10 rounded-full text-[10px] font-bold border border-white/10"># {t}</span>
                                            )) : <span className="text-[10px] opacity-30 italic">Complete a quiz to see insights</span>}
                                        </div>
                                    </div>
                                    <Icon name="bar-chart-2" className="absolute -right-4 -bottom-4 w-24 h-24 opacity-10" />
                                </div>

                                <button onClick={startQuiz} className="w-full bg-blue-600 text-white p-8 rounded-[2.5rem] shadow-2xl shadow-blue-200 flex items-center justify-between group active:scale-95 transition-all">
                                    <div className="text-left">
                                        <h3 className="text-xl font-black italic tracking-tight">SMART PRACTICE</h3>
                                        <p className="text-[10px] opacity-70 font-bold uppercase tracking-[0.1em] mt-1">5 Adaptive Questions</p>
                                    </div>
                                    <div className="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center group-hover:bg-white/30 transition-colors">
                                        <Icon name="play" className="w-5 h-5 fill-current" />
                                    </div>
                                </button>

                                {user?.isAnonymous && (
                                    <button onClick={() => sdk.lib.signInWithPopup(sdk.auth, sdk.provider)} className="w-full p-4 border-2 border-dashed border-slate-200 rounded-2xl flex items-center justify-center gap-3 text-xs font-bold text-slate-500 hover:bg-white transition-all">
                                        <Icon name="log-in" className="w-4 h-4" /> Save progress with Google Account
                                    </button>
                                )}
                            </div>
                        )}

                        {view === 'quiz' && (
                            <div className="space-y-6 fade-in">
                                <div className="flex justify-between items-center text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                    <span>Progress {currentIndex + 1} / {currentQuiz.length}</span>
                                    <button onClick={() => setView('lobby')} className="text-red-400">Abort</button>
                                </div>
                                <div className="bg-white p-10 rounded-[2.5rem] border shadow-sm min-h-[160px] flex items-center justify-center text-center">
                                    <p className="text-xl font-bold text-slate-800 leading-snug tracking-tight">{currentQuiz[currentIndex].text}</p>
                                </div>
                                <div className="grid gap-3">
                                    {currentQuiz[currentIndex].options.map((opt, i) => (
                                        <button key={i} disabled={!!feedback} onClick={() => handleAnswer(i)}
                                            className={`w-full p-5 rounded-2xl text-left font-bold border-2 transition-all flex items-center gap-4
                                            ${!feedback ? 'bg-white border-slate-50 hover:border-blue-400 hover:translate-x-1 shadow-sm' : ''}
                                            ${feedback === 'correct' && i === currentQuiz[currentIndex].correct_answer ? 'bg-green-50 border-green-500 text-green-700' : ''}
                                            ${feedback === 'wrong' && i === currentQuiz[currentIndex].correct_answer ? 'bg-green-50 border-green-500 text-green-700' : ''}
                                            ${feedback === 'wrong' && i !== currentQuiz[currentIndex].correct_answer ? 'opacity-40 grayscale border-slate-50' : ''}`}>
                                            <span className={`w-8 h-8 rounded-lg flex items-center justify-center text-xs font-black
                                                ${feedback === 'correct' && i === currentQuiz[currentIndex].correct_answer ? 'bg-green-500 text-white' : 'bg-slate-100 text-slate-400'}`}>
                                                {String.fromCharCode(65+i)}
                                            </span>
                                            {opt}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'results' && (
                            <div className="text-center py-16 space-y-8 fade-in">
                                <div className="relative inline-block">
                                    <div className="text-7xl font-black text-blue-600 italic tracking-tighter">{sessionScore} / {currentQuiz.length}</div>
                                    <Icon name="award" className="absolute -top-6 -right-6 w-12 h-12 text-yellow-400 animate-bounce" />
                                </div>
                                <div className="space-y-2">
                                    <h3 className="text-2xl font-black text-slate-800 tracking-tight">Session Complete!</h3>
                                    <p className="text-sm font-bold text-slate-400">Great work. Your performance has been synced to your profile.</p>
                                </div>
                                <button onClick={() => setView('lobby')} className="w-full bg-slate-900 text-white p-6 rounded-[2rem] font-black text-lg shadow-xl active:scale-95 transition-all">Continue Journey</button>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
