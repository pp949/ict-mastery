<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSE ICT Mastery | Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
    </style>
</head>
<body class="bg-[#f8fafc]">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDocs, addDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Hardcoded for GitHub Pages reliability
        const firebaseConfig = {
            apiKey: "AIzaSyDSpaXWx2_qT88ffyTdmH43j63PUyJ82-4",
            authDomain: "ict-learning-platform.firebaseapp.com",
            projectId: "ict-learning-platform",
            storageBucket: "ict-learning-platform.firebasestorage.app",
            messagingSenderId: "720934184836",
            appId: "1:720934184836:web:2360db67abb324890e1fd1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        window.FirebaseSDK = { auth, db, provider, signInWithPopup, signOut, onAuthStateChanged, collection, doc, getDocs, addDoc, serverTimestamp, onSnapshot };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const appId = "ict-mastery-v1"; // FORCE MATCH THIS WITH TEACHER APP

        function App() {
            const [user, setUser] = useState(null);
            const [topics, setTopics] = useState([]);
            const [view, setView] = useState('lobby');
            const [questions, setQuestions] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [feedback, setFeedback] = useState(null);
            const [userStats, setUserStats] = useState({ total: 0, correct: 0 });
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const check = setInterval(() => {
                    if (window.FirebaseSDK) {
                        clearInterval(check);
                        window.FirebaseSDK.onAuthStateChanged(window.FirebaseSDK.auth, (u) => {
                            setUser(u);
                            setLoading(false);
                        });
                    }
                }, 100);
            }, []);

            useEffect(() => {
                if (!user || !window.FirebaseSDK) return;
                const { db, collection, onSnapshot } = window.FirebaseSDK;

                // Watch Questions
                const qRef = collection(db, 'artifacts', appId, 'public', 'data', 'questions');
                const unsubQ = onSnapshot(qRef, (snap) => {
                    const t = new Set();
                    snap.forEach(d => (d.data().topic_tags || ["General"]).forEach(tag => t.add(tag)));
                    setTopics(Array.from(t));
                });

                // Watch My Stats
                const sRef = collection(db, 'artifacts', appId, 'users', user.uid, 'attempts');
                const unsubS = onSnapshot(sRef, (snap) => {
                    let c = 0;
                    snap.forEach(d => { if(d.data().isCorrect) c++; });
                    setUserStats({ total: snap.size, correct: c });
                });

                return () => { unsubQ(); unsubS(); };
            }, [user]);

            const startQuiz = async (topic) => {
                const { db, collection, getDocs } = window.FirebaseSDK;
                setLoading(true);
                const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'questions'));
                const filtered = snap.docs.map(d => ({id: d.id, ...d.data()})).filter(q => (q.topic_tags || []).includes(topic));
                setQuestions(filtered);
                setCurrentIndex(0);
                setView('quiz');
                setLoading(false);
            };

            const handleAnswer = async (idx) => {
                if (feedback) return;
                const { db, collection, addDoc, serverTimestamp } = window.FirebaseSDK;
                const q = questions[currentIndex];
                const isCorrect = idx === q.correct_answer;
                setFeedback(isCorrect ? 'correct' : 'wrong');

                const data = {
                    uid: user.uid,
                    displayName: user.displayName,
                    topic: q.topic_tags[0],
                    isCorrect,
                    timestamp: serverTimestamp()
                };

                // DUAL WRITE
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'attempts'), data);
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'activity_feed'), data);

                setTimeout(() => {
                    if (currentIndex + 1 < questions.length) {
                        setCurrentIndex(c => c + 1);
                        setFeedback(null);
                    } else {
                        setView('lobby');
                        setFeedback(null);
                    }
                }, 1000);
            };

            if (loading) return <div className="h-screen flex items-center justify-center font-bold text-slate-400">INITIALIZING...</div>;

            if (!user) return (
                <div className="h-screen flex items-center justify-center">
                    <button 
                        onClick={() => window.FirebaseSDK.signInWithPopup(window.FirebaseSDK.auth, window.FirebaseSDK.provider)}
                        className="bg-white border p-4 rounded-xl font-bold shadow-sm"
                    > Login with Google </button>
                </div>
            );

            return (
                <div className="p-6 max-w-xl mx-auto">
                    <header className="flex justify-between items-center mb-8">
                        <h1 className="font-black text-xl">ICT MASTERY</h1>
                        <div className="bg-blue-600 text-white px-3 py-1 rounded-full text-xs font-bold">Score: {userStats.correct}</div>
                    </header>

                    {view === 'lobby' ? (
                        <div className="space-y-4">
                            <div className="bg-white p-6 rounded-3xl border shadow-sm mb-6">
                                <p className="text-xs font-bold text-slate-400 uppercase">Success Rate</p>
                                <p className="text-4xl font-black">{userStats.total > 0 ? Math.round((userStats.correct/userStats.total)*100) : 0}%</p>
                            </div>
                            {topics.map(t => (
                                <button key={t} onClick={() => startQuiz(t)} className="w-full bg-white p-5 rounded-2xl border text-left font-bold hover:border-blue-500">
                                    {t}
                                </button>
                            ))}
                        </div>
                    ) : (
                        <div className="space-y-6">
                            <div className="bg-white p-8 rounded-3xl border shadow-sm text-center">
                                <p className="font-bold text-slate-800 text-lg">{questions[currentIndex].text}</p>
                            </div>
                            <div className="grid gap-3">
                                {questions[currentIndex].options.map((o, i) => (
                                    <button key={i} onClick={() => handleAnswer(i)} className={`p-5 rounded-2xl text-left font-bold border-2 ${feedback ? (i === questions[currentIndex].correct_answer ? 'border-green-500 bg-green-50' : 'opacity-50') : 'bg-white border-slate-100'}`}>
                                        {o}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
