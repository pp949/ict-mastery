<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSE ICT Mastery - Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .option-card { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .mermaid { background: white; border-radius: 1rem; padding: 1.5rem; margin: 1.5rem 0; display: flex; justify-content: center; overflow-x: auto; border: 1px solid #e2e8f0; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Global Firebase Config
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        window.FB = { 
            auth, 
            db, 
            appId, 
            methods: { 
                onAuthStateChanged, 
                signInAnonymously, 
                signInWithCustomToken,
                collection, 
                onSnapshot, 
                addDoc, 
                serverTimestamp 
            } 
        };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const Icon = ({ name, className }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        const MermaidChart = ({ code }) => {
            const chartRef = useRef(null);
            useEffect(() => {
                if (code && chartRef.current) {
                    mermaid.initialize({ startOnLoad: false, theme: 'neutral', securityLevel: 'loose' });
                    mermaid.contentLoaded();
                    mermaid.init(undefined, chartRef.current);
                }
            }, [code]);

            if (!code) return null;
            return <div className="mermaid" ref={chartRef}>{code}</div>;
        };

        function App() {
            const [view, setView] = useState('landing'); // landing, quiz, results
            const [user, setUser] = useState(null);
            const [questions, setQuestions] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [selectedIndices, setSelectedIndices] = useState([]);
            const [isSubmitted, setIsSubmitted] = useState(false);
            const [score, setScore] = useState(0);
            const [loading, setLoading] = useState(true);

            // Authentication Handler (Rule 3: Auth Before Queries)
            useEffect(() => {
                const initAuth = async () => {
                    if (!window.FB) {
                        window.addEventListener('firebase-ready', initAuth);
                        return;
                    }
                    const { auth, methods } = window.FB;
                    
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await methods.signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await methods.signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.error("Auth failed", err);
                    }

                    const unsubscribe = methods.onAuthStateChanged(auth, setUser);
                    return () => unsubscribe();
                };
                initAuth();
            }, []);

            // Data Fetching Handler (Rule 3: Guard with user check)
            useEffect(() => {
                if (!user || !window.FB) return;
                
                const { db, appId, methods } = window.FB;
                const qRef = methods.collection(db, 'artifacts', appId, 'public', 'data', 'questions');
                
                const unsub = methods.onSnapshot(qRef, (snap) => {
                    const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setQuestions(data);
                    setLoading(false);
                }, (err) => {
                    console.error("Firestore snapshot error:", err);
                    setLoading(false);
                });
                
                return () => unsub();
            }, [user]);

            const currentQ = questions[currentIndex];

            const toggleOption = (idx) => {
                if (isSubmitted) return;
                if (currentQ.type === 'MC1') {
                    setSelectedIndices([idx]);
                } else {
                    setSelectedIndices(prev => 
                        prev.includes(idx) ? prev.filter(i => i !== idx) : [...prev, idx]
                    );
                }
            };

            const handleSubmit = async () => {
                if (!user) return;

                const isMC2 = currentQ.type === 'MC2';
                const correct = currentQ.correct_answer;
                let isCorrect = false;

                if (isMC2) {
                    const sortedSelected = [...selectedIndices].sort();
                    const sortedCorrect = Array.isArray(correct) ? [...correct].sort() : [correct];
                    isCorrect = JSON.stringify(sortedSelected) === JSON.stringify(sortedCorrect);
                } else {
                    isCorrect = selectedIndices[0] === correct;
                }

                if (isCorrect) setScore(s => s + 1);
                setIsSubmitted(true);

                const { db, appId, methods } = window.FB;
                try {
                    await methods.addDoc(methods.collection(db, 'artifacts', appId, 'public', 'data', 'activity_feed'), {
                        userId: user.uid,
                        displayName: user.isAnonymous ? `Student ${user.uid.slice(0, 4)}` : user.displayName,
                        questionId: currentQ.question_id || currentQ.id,
                        topic: Array.isArray(currentQ.topic) ? currentQ.topic[0] : (currentQ.topic || 'General'),
                        isCorrect,
                        timestamp: methods.serverTimestamp()
                    });
                } catch (e) { console.error("Logging error", e); }
            };

            const nextStep = () => {
                if (currentIndex < questions.length - 1) {
                    setCurrentIndex(i => i + 1);
                    setSelectedIndices([]);
                    setIsSubmitted(false);
                } else {
                    setView('results');
                }
            };

            if (loading) return (
                <div className="h-screen flex items-center justify-center">
                    <div className="animate-spin h-10 w-10 border-4 border-blue-600 border-t-transparent rounded-full"></div>
                </div>
            );

            if (view === 'landing') return (
                <div className="min-h-screen flex items-center justify-center p-6">
                    <div className="max-w-md w-full text-center space-y-8">
                        <div className="bg-blue-600 w-20 h-20 rounded-3xl flex items-center justify-center mx-auto shadow-xl shadow-blue-200">
                            <Icon name="book-open" className="w-10 h-10 text-white" />
                        </div>
                        <div className="space-y-2">
                            <h1 className="text-4xl font-black text-slate-900 italic tracking-tight">ICT MASTERY</h1>
                            <p className="text-slate-500 font-bold uppercase tracking-[0.2em] text-xs">Syllabus Deployment V2.0</p>
                        </div>
                        <button 
                            onClick={() => setView('quiz')}
                            className="w-full bg-slate-900 text-white py-5 rounded-2xl font-black uppercase tracking-widest hover:bg-slate-800 transition-all shadow-lg active:scale-95"
                        >
                            Start Session
                        </button>
                    </div>
                </div>
            );

            if (view === 'results') return (
                <div className="min-h-screen flex items-center justify-center p-6">
                    <div className="max-w-md w-full bg-white p-10 rounded-[2.5rem] shadow-xl border border-slate-100 text-center">
                        <div className="mb-6 inline-block p-4 bg-green-100 rounded-full">
                            <Icon name="award" className="w-12 h-12 text-green-600" />
                        </div>
                        <h2 className="text-3xl font-black text-slate-900 mb-2">Session Complete</h2>
                        <p className="text-slate-500 font-bold mb-8">Great job on finishing the deployment!</p>
                        <div className="bg-slate-50 rounded-3xl p-6 mb-8">
                            <div className="text-5xl font-black text-blue-600 mb-1">{Math.round((score / (questions.length || 1)) * 100)}%</div>
                            <div className="text-xs font-black text-slate-400 uppercase tracking-widest">Accuracy Score</div>
                        </div>
                        <button 
                            onClick={() => window.location.reload()}
                            className="w-full bg-blue-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest hover:bg-blue-700 transition-all"
                        >
                            Try Again
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="max-w-2xl mx-auto min-h-screen p-6 flex flex-col">
                    <header className="flex justify-between items-center mb-8">
                        <div className="flex items-center gap-3">
                            <div className="bg-slate-900 p-2 rounded-lg"><Icon name="cpu" className="w-5 h-5 text-white" /></div>
                            <span className="font-black italic text-slate-900 uppercase text-sm">ICT Mastery</span>
                        </div>
                        <div className="bg-blue-50 px-4 py-2 rounded-full border border-blue-100">
                            <span className="text-blue-700 font-black text-xs uppercase tracking-widest">Q {currentIndex + 1} / {questions.length}</span>
                        </div>
                    </header>

                    {currentQ ? (
                        <div className="bg-white rounded-[2.5rem] p-8 md:p-10 shadow-xl border border-slate-100 flex-grow mb-6 relative overflow-hidden">
                            <div className="flex flex-wrap gap-2 mb-6">
                                {(currentQ.topic || []).map(t => (
                                    <span key={t} className="bg-blue-600 text-white px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest">{t}</span>
                                ))}
                                <span className={`px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest border ${currentQ.type === 'MC2' ? 'bg-purple-50 text-purple-700 border-purple-100' : 'bg-orange-50 text-orange-700 border-orange-100'}`}>
                                    {currentQ.type}
                                </span>
                            </div>

                            <h3 className="text-xl md:text-2xl font-black text-slate-800 leading-tight mb-6">
                                {currentQ.text}
                            </h3>

                            <MermaidChart code={currentQ.mermaid_code} />

                            <div className="space-y-3 mt-8">
                                {(currentQ.options || []).map((opt, i) => {
                                    const isSelected = selectedIndices.includes(i);
                                    const isCorrect = Array.isArray(currentQ.correct_answer) ? currentQ.correct_answer.includes(i) : currentQ.correct_answer === i;
                                    
                                    let stateClasses = "bg-slate-50 border-slate-100 text-slate-700 hover:border-blue-300";
                                    if (isSubmitted) {
                                        if (isCorrect) stateClasses = "bg-green-50 border-green-400 text-green-800";
                                        else if (isSelected) stateClasses = "bg-red-50 border-red-400 text-red-800";
                                        else stateClasses = "bg-slate-50 border-slate-100 opacity-50";
                                    } else if (isSelected) {
                                        stateClasses = "bg-blue-600 border-blue-600 text-white shadow-lg shadow-blue-200 translate-x-1";
                                    }

                                    return (
                                        <button 
                                            key={i}
                                            onClick={() => toggleOption(i)}
                                            disabled={isSubmitted}
                                            className={`w-full p-5 rounded-2xl border-2 text-left font-bold transition-all flex items-center gap-4 option-card ${stateClasses}`}
                                        >
                                            <div className={`w-6 h-6 rounded-lg flex items-center justify-center text-xs font-black ${isSelected ? 'bg-white text-blue-600' : 'bg-slate-200 text-slate-500'}`}>
                                                {String.fromCharCode(65 + i)}
                                            </div>
                                            <span className="flex-grow">{opt}</span>
                                            {isSubmitted && isCorrect && <Icon name="check-circle" className="w-5 h-5 text-green-600" />}
                                            {isSubmitted && !isCorrect && isSelected && <Icon name="x-circle" className="w-5 h-5 text-red-600" />}
                                        </button>
                                    );
                                })}
                            </div>

                            {isSubmitted && (
                                <div className="mt-8 p-6 bg-slate-900 rounded-3xl text-white animate-in slide-in-from-top-4 duration-300">
                                    <p className="text-blue-400 font-black uppercase text-[10px] tracking-widest mb-2 flex items-center gap-2">
                                        <Icon name="info" className="w-3 h-3" />
                                        Explanation
                                    </p>
                                    <p className="text-sm leading-relaxed text-slate-300 font-medium">
                                        {currentQ.explanation}
                                    </p>
                                    <div className="mt-4 pt-4 border-t border-slate-800 italic text-slate-400 text-xs">
                                        <span className="font-bold text-blue-400 uppercase tracking-tighter mr-2">Hint:</span>
                                        {currentQ.hints}
                                    </div>
                                </div>
                            )}
                        </div>
                    ) : (
                        <div className="bg-white rounded-[2.5rem] p-8 text-center border border-slate-100 shadow-xl">
                            <p className="text-slate-500 font-bold">Waiting for questions to sync...</p>
                        </div>
                    )}

                    <div className="flex gap-4">
                        {!isSubmitted ? (
                            <button 
                                onClick={handleSubmit}
                                disabled={selectedIndices.length === 0}
                                className={`w-full py-5 rounded-2xl font-black uppercase tracking-widest transition-all ${selectedIndices.length === 0 ? 'bg-slate-200 text-slate-400' : 'bg-blue-600 text-white shadow-xl shadow-blue-200 active:scale-95'}`}
                            >
                                Confirm Selection
                            </button>
                        ) : (
                            <button 
                                onClick={nextStep}
                                className="w-full bg-slate-900 text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-xl active:scale-95 flex items-center justify-center gap-3 transition-all"
                            >
                                {currentIndex === questions.length - 1 ? 'Finish Results' : 'Next Challenge'}
                                <Icon name="arrow-right" className="w-5 h-5" />
                            </button>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
