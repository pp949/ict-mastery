<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSE ICT Mastery - Student Portal</title>
    
    <!-- Styling & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .animate-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>

    <!-- React Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDK Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { 
            getAuth, onAuthStateChanged, signInAnonymously, signInWithRedirect, 
            getRedirectResult, GoogleAuthProvider, setPersistence, 
            browserLocalPersistence, signOut 
        } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { 
            getFirestore, collection, onSnapshot, addDoc, getDocs, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // --- REPLACE THIS WITH YOUR FIREBASE CONFIG FROM CONSOLE ---
        const firebaseConfig = {
        apiKey: "AIzaSyDSpaXWx2_qT88ffyTdmH43j63PUyJ82-4",
        authDomain: "ict-learning-platform.firebaseapp.com",
        projectId: "ict-learning-platform",
        storageBucket: "ict-learning-platform.firebasestorage.app",
        messagingSenderId: "720934184836",
        appId: "1:720934184836:web:2360db67abb324890e1fd1",
        measurementId: "G-2CF8HRGW6C"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Expose to window for the Babel script
        window.FB = { 
            auth, db, 
            providers: { GoogleAuthProvider },
            methods: { 
                onAuthStateChanged, signInAnonymously, signInWithRedirect, 
                getRedirectResult, setPersistence, browserLocalPersistence, 
                signOut, collection, onSnapshot, addDoc, getDocs, serverTimestamp 
            }
        };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <!-- Main App Logic -->
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Simple Icon Component for Deployment
        const Icon = ({ name, className }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [authChecking, setAuthChecking] = useState(true);
            const [view, setView] = useState('lobby');
            const [topics, setTopics] = useState([]);
            const [currentTopic, setCurrentTopic] = useState(null);
            const [questions, setQuestions] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [feedback, setFeedback] = useState(null);
            const [sessionScore, setSessionScore] = useState(0);
            const [userStats, setUserStats] = useState({ total: 0, correct: 0 });
            const appId = "default-app-id"; // Adjust if using multi-tenant

            useEffect(() => {
                const init = async () => {
                    if (!window.FB) {
                        window.addEventListener('firebase-ready', init);
                        return;
                    }
                    const { auth, methods } = window.FB;
                    
                    await methods.setPersistence(auth, methods.browserLocalPersistence);
                    const result = await methods.getRedirectResult(auth);
                    
                    methods.onAuthStateChanged(auth, (u) => {
                        setUser(u);
                        setAuthChecking(false);
                        if (!u) methods.signInAnonymously(auth);
                    });
                };
                init();
            }, []);

            useEffect(() => {
                if (!user || !window.FB) return;
                const { db, methods } = window.FB;

                const qRef = methods.collection(db, 'artifacts', appId, 'public', 'data', 'questions');
                const unsubTopics = methods.onSnapshot(qRef, (snap) => {
                    const tags = new Set();
                    snap.forEach(doc => {
                        const t = doc.data().topic || "General";
                        tags.add(t);
                    });
                    setTopics(Array.from(tags).sort());
                });

                const statsRef = methods.collection(db, 'artifacts', appId, 'users', user.uid, 'attempts');
                const unsubStats = methods.onSnapshot(statsRef, (snap) => {
                    let correct = 0;
                    snap.forEach(d => { if (d.data().isCorrect) correct++; });
                    setUserStats({ total: snap.size, correct });
                });

                return () => { unsubTopics(); unsubStats(); };
            }, [user]);

            const startQuiz = async (topic) => {
                const { db, methods } = window.FB;
                const qRef = methods.collection(db, 'artifacts', appId, 'public', 'data', 'questions');
                const snapshot = await methods.getDocs(qRef);
                const filtered = snapshot.docs
                    .map(d => ({ id: d.id, ...d.data() }))
                    .filter(q => q.topic === topic);
                
                setQuestions(filtered);
                setCurrentTopic(topic);
                setCurrentIndex(0);
                setSessionScore(0);
                setView('quiz');
            };

            const handleAnswer = async (idx) => {
                if (feedback) return;
                const q = questions[currentIndex];
                const correct = idx === q.correct_answer;
                const { db, methods } = window.FB;

                setFeedback(correct ? 'correct' : 'wrong');
                if (correct) setSessionScore(s => s + 1);

                await methods.addDoc(methods.collection(db, 'artifacts', appId, 'users', user.uid, 'attempts'), {
                    question_id: q.id,
                    isCorrect: correct,
                    timestamp: methods.serverTimestamp()
                });

                setTimeout(() => {
                    if (currentIndex + 1 < questions.length) {
                        setCurrentIndex(c => c + 1);
                        setFeedback(null);
                    } else {
                        setView('results');
                    }
                }, 1000);
            };

            if (authChecking) return (
                <div className="h-screen flex items-center justify-center">
                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                </div>
            );

            return (
                <div className="max-w-md mx-auto min-h-screen bg-slate-50 shadow-xl overflow-hidden flex flex-col">
                    <header className="bg-white p-6 border-b flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <Icon name="book-open" className="text-blue-600 w-6 h-6" />
                            <h1 className="font-bold text-xl">ICT Master</h1>
                        </div>
                        <div className="bg-blue-600 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center gap-2">
                            <Icon name="trophy" className="w-4 h-4" />
                            {userStats.correct}
                        </div>
                    </header>

                    <main className="p-4 flex-1">
                        {view === 'lobby' && (
                            <div className="space-y-4 animate-in">
                                <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                                    <h2 className="text-slate-400 text-xs font-bold uppercase tracking-widest mb-2">My Progress</h2>
                                    <p className="text-4xl font-black">{userStats.total} <span className="text-sm font-normal text-slate-400">Attempts</span></p>
                                </div>
                                <h3 className="font-bold text-lg px-2">Choose a Topic</h3>
                                <div className="grid gap-3">
                                    {topics.length > 0 ? topics.map(t => (
                                        <button key={t} onClick={() => startQuiz(t)} className="bg-white p-5 rounded-2xl border border-slate-200 text-left font-bold flex justify-between items-center hover:border-blue-500 transition-all">
                                            {t} <Icon name="chevron-right" className="text-slate-300" />
                                        </button>
                                    )) : <p className="text-center py-10 text-slate-400">No questions loaded yet.</p>}
                                </div>
                            </div>
                        )}

                        {view === 'quiz' && (
                            <div className="space-y-6 animate-in">
                                <div className="bg-white p-8 rounded-3xl border border-slate-200 text-center">
                                    <h2 className="text-xl font-bold">{questions[currentIndex].text}</h2>
                                </div>
                                <div className="grid gap-3">
                                    {questions[currentIndex].options.map((opt, i) => (
                                        <button 
                                            key={i} 
                                            onClick={() => handleAnswer(i)}
                                            className={`p-5 rounded-2xl border-2 text-left font-bold transition-all ${
                                                feedback === null ? 'bg-white border-slate-100 hover:border-blue-500' : 
                                                (i === questions[currentIndex].correct_answer ? 'bg-green-50 border-green-500 text-green-700' : 'bg-white opacity-50')
                                            }`}
                                        >
                                            {opt}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'results' && (
                            <div className="text-center py-10 space-y-6 animate-in">
                                <Icon name="check-circle" className="w-20 h-20 text-green-500 mx-auto" />
                                <h2 className="text-3xl font-black">Session Done!</h2>
                                <p className="text-slate-500 font-bold">You got {sessionScore} correct.</p>
                                <button onClick={() => setView('lobby')} className="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold">Back to Lobby</button>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
