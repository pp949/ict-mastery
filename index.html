<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSE ICT Mastery - Student App</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel for "Single File" execution on GitHub Pages -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase Compat Libraries (Standard for browser script tags) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Safety check for environment variables
        const getFirebaseConfig = () => {
            try {
                if (typeof __firebase_config !== 'undefined') {
                    return JSON.parse(__firebase_config);
                }
            } catch (e) {
                console.error("Firebase config parsing failed:", e);
            }
            // Fallback empty config to prevent crash (User should provide this)
            return {};
        };

        const firebaseConfig = getFirebaseConfig();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Initialize Firebase using compat mode
        if (firebaseConfig.apiKey) {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('lobby');
            const [topics, setTopics] = useState([]);
            const [currentTopic, setCurrentTopic] = useState(null);
            const [questions, setQuestions] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [feedback, setFeedback] = useState(null);
            const [sessionScore, setSessionScore] = useState(0);
            const [userStats, setUserStats] = useState({ total: 0, correct: 0 });
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (u) => {
                    if (!u) {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await auth.signInWithCustomToken(__initial_auth_token);
                            } else {
                                await auth.signInAnonymously();
                            }
                        } catch (err) {
                            console.error("Auth error:", err);
                        }
                    } else {
                        setUser(u);
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;

                // Load Topics
                const qRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('questions');
                const unsubTopics = qRef.onSnapshot((snapshot) => {
                    const tags = new Set();
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const t = data.topic_tags || data.topic || data.tags || ["General"];
                        (Array.isArray(t) ? t : [t]).forEach(tag => tags.add(tag));
                    });
                    setTopics(Array.from(tags).sort());
                    setLoading(false);
                }, err => {
                    console.error("Topics load fail:", err);
                    setLoading(false);
                });

                // Load User Stats
                const statsRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('attempts');
                const unsubStats = statsRef.onSnapshot((snapshot) => {
                    let correct = 0;
                    snapshot.forEach(doc => {
                        if (doc.data().isCorrect) correct++;
                    });
                    setUserStats({ total: snapshot.size, correct });
                }, err => console.error("Stats load fail:", err));

                return () => {
                    unsubTopics();
                    unsubStats();
                };
            }, [user]);

            const startQuiz = async (topic) => {
                setLoading(true);
                try {
                    const qRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('questions');
                    const snapshot = await qRef.get();
                    const filtered = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(q => {
                            const t = q.topic_tags || q.topic || q.tags || ["General"];
                            return Array.isArray(t) ? t.includes(topic) : t === topic;
                        });
                    
                    setQuestions(filtered);
                    setCurrentTopic(topic);
                    setCurrentIndex(0);
                    setSessionScore(0);
                    setFeedback(null);
                    setView('quiz');
                } catch (e) {
                    console.error("Error loading quiz:", e);
                }
                setLoading(false);
            };

            const handleAnswer = async (index) => {
                if (feedback) return;
                const q = questions[currentIndex];
                const correct = index === q.correct_answer;
                
                if (correct) setSessionScore(prev => prev + 1);
                setFeedback(correct ? 'correct' : 'wrong');

                try {
                    const timestamp = firebase.firestore.FieldValue.serverTimestamp();
                    
                    // Log to Private User History
                    await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('attempts').add({
                        question_id: q.id,
                        topic: currentTopic,
                        isCorrect: correct,
                        timestamp: timestamp
                    });

                    // Log to Public Activity Feed
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('activity_feed').add({
                        uid: user.uid,
                        topic: currentTopic,
                        isCorrect: correct,
                        timestamp: timestamp
                    });
                } catch (e) {
                    console.error("Sync error:", e);
                }

                setTimeout(() => {
                    if (currentIndex + 1 < questions.length) {
                        setCurrentIndex(prev => prev + 1);
                        setFeedback(null);
                    } else {
                        setView('results');
                        setFeedback(null);
                    }
                }, 1200);
            };

            if (!user || loading) {
                return (
                    <div className="flex h-screen items-center justify-center flex-col gap-4">
                        <div className="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                        <div className="font-bold text-slate-400">Syncing with Classroom...</div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50 pb-10 antialiased font-sans">
                    <header className="bg-white border-b px-6 py-4 flex justify-between items-center sticky top-0 z-20 shadow-sm">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-600 p-2 rounded-lg text-white font-bold text-xs">ICT</div>
                            <h1 className="text-lg font-bold text-slate-900">DSE Mastery</h1>
                        </div>
                        <div className="flex items-center gap-2 bg-blue-50 px-3 py-1.5 rounded-xl">
                            <span className="text-xs font-black text-blue-700">{userStats.correct} Correct</span>
                        </div>
                    </header>

                    <main className="max-w-2xl mx-auto p-4 sm:p-6">
                        {view === 'lobby' && (
                            <div className="space-y-6">
                                <div className="bg-white rounded-3xl p-8 border border-slate-200 shadow-sm">
                                    <h2 className="text-slate-500 text-xs font-bold uppercase mb-4 tracking-widest">Progress</h2>
                                    <div className="text-5xl font-black text-slate-900 mb-6">{userStats.total} <span className="text-xs text-slate-400 uppercase">Attempts</span></div>
                                    <div className="w-full bg-slate-100 rounded-full h-3">
                                        <div className="bg-blue-600 h-3 rounded-full transition-all duration-500" style={{width: `${userStats.total > 0 ? (userStats.correct/userStats.total)*100 : 0}%`}}></div>
                                    </div>
                                </div>

                                <div className="grid gap-3">
                                    <h3 className="font-bold text-slate-800 text-lg">Topics</h3>
                                    {topics.length === 0 ? (
                                        <div className="p-10 text-center text-slate-400 bg-white rounded-2xl border border-dashed border-slate-300">
                                            Waiting for teacher to upload questions...
                                        </div>
                                    ) : (
                                        topics.map(t => (
                                            <button key={t} onClick={() => startQuiz(t)} className="bg-white p-5 rounded-2xl border border-slate-200 text-left font-bold hover:border-blue-500 transition-all flex justify-between items-center shadow-sm active:scale-95">
                                                {t} <span className="text-blue-500">‚Üí</span>
                                            </button>
                                        ))
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'quiz' && (
                            <div className="space-y-6 animate-in fade-in">
                                <div className="flex justify-between items-center text-[10px] font-black text-slate-400 uppercase">
                                    <span className="bg-slate-200 px-2 py-1 rounded">{currentTopic}</span>
                                    <span>{currentIndex + 1} / {questions.length}</span>
                                </div>
                                <div className="bg-white p-10 rounded-3xl shadow-sm border border-slate-200 text-center">
                                    <h2 className="text-xl font-black text-slate-900">{questions[currentIndex]?.text}</h2>
                                </div>
                                <div className="grid gap-3">
                                    {questions[currentIndex]?.options.map((opt, i) => (
                                        <button key={i} onClick={() => handleAnswer(i)} disabled={!!feedback} className={`w-full p-5 rounded-2xl text-left font-bold border-2 transition-all ${feedback ? (i === questions[currentIndex].correct_answer ? 'border-green-500 bg-green-50 text-green-700' : 'border-slate-100 opacity-50') : 'bg-white border-slate-100 hover:border-blue-500'}`}>
                                            {opt}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'results' && (
                            <div className="text-center py-10 space-y-6">
                                <div className="text-6xl mb-4">üèÜ</div>
                                <h2 className="text-4xl font-black text-slate-900 italic">Session Clear!</h2>
                                <p className="text-slate-500 font-bold uppercase text-xs tracking-widest">Score: {sessionScore} / {questions.length}</p>
                                <button onClick={() => setView('lobby')} className="bg-slate-900 text-white px-8 py-4 rounded-2xl font-black shadow-lg hover:bg-blue-600 transition-colors">Back to Lobby</button>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
